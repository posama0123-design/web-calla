<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>スマート電話 Pro</title>

<style>
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body {
    margin:0;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
    height:100vh;
    overflow:hidden;
    background:#fff;
}

.phone-container {
    max-width:400px;
    margin:auto;
    height:100vh;
    display:flex;
    flex-direction:column;
    position:relative;
}

.screen {
    flex:1;
    display:none;
    padding:20px;
    overflow-y:auto;
    padding-bottom:120px;
}
.screen.active { display:block; }

.header {
    text-align:center;
    padding:15px 0;
    border-bottom:1px solid #eee;
}
.display-number {
    font-size:28px;
    font-weight:300;
}
.status {
    font-size:13px;
    color:#007aff;
}

/* キーパッド */
.keypad {
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:15px;
    margin-top:20px;
}
.key {
    width:75px;
    height:75px;
    background:#f2f2f7;
    border-radius:50%;
    margin:auto;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:28px;
}
.key:active { background:#d1d1d6; }

/* 連絡先 */
.contact-item {
    padding:15px;
    border-bottom:1px solid #eee;
    display:flex;
    justify-content:space-between;
}
.contact-item:active { background:#f5f5f5; }

/* SMS */
#message-list {
    display:flex;
    flex-direction:column;
}
.msg-bubble {
    max-width:80%;
    padding:10px 14px;
    border-radius:18px;
    margin:6px 0;
    word-break:break-word;
}
.msg-sent {
    background:#007aff;
    color:#fff;
    margin-left:auto;
}
.msg-received {
    background:#e5e5ea;
    color:#000;
}

.msg-input-area {
    position:fixed;
    bottom:80px;
    width:100%;
    max-width:400px;
    display:flex;
    padding:10px;
    background:#fff;
    border-top:1px solid #eee;
}
.msg-input {
    flex:1;
    padding:10px;
    border-radius:20px;
    border:1px solid #ccc;
    margin-right:10px;
}

/* ナビ */
.nav-bar {
    position:absolute;
    bottom:0;
    width:100%;
    height:80px;
    display:flex;
    justify-content:space-around;
    align-items:center;
    border-top:1px solid #ddd;
    background:#f8f8f8;
}
.nav-item {
    font-size:10px;
    color:#888;
    text-align:center;
}
.nav-item.active { color:#007aff; }
.nav-item svg {
    width:24px;
    height:24px;
    display:block;
    margin:0 auto 4px;
    fill:currentColor;
}
</style>
</head>

<body>
<div class="phone-container">

<!-- ダイヤル -->
<div id="dialer-screen" class="screen active">
    <div class="header">
        <div id="my-number-info" class="status">読込中...</div>
        <div class="display-number" id="numberDisplay"></div>
    </div>

    <div class="keypad">
        <div class="key" onclick="press('1')">1</div>
        <div class="key" onclick="press('2')">2</div>
        <div class="key" onclick="press('3')">3</div>
        <div class="key" onclick="press('4')">4</div>
        <div class="key" onclick="press('5')">5</div>
        <div class="key" onclick="press('6')">6</div>
        <div class="key" onclick="press('7')">7</div>
        <div class="key" onclick="press('8')">8</div>
        <div class="key" onclick="press('9')">9</div>
        <div class="key" onclick="press('*')">*</div>
        <div class="key" onclick="press('0')">0</div>
        <div class="key" onclick="press('#')">#</div>
    </div>

    <div style="text-align:center;margin-top:20px;">
        <button onclick="openChat(numberDisplay.innerText)">SMS</button>
        <button onclick="backspace()">⌫</button>
    </div>
</div>

<!-- 連絡先 -->
<div id="contacts-screen" class="screen">
    <h3>連絡先</h3>
    <button onclick="addContact()" style="width:100%;padding:10px;">＋ 新規追加</button>
    <div id="contact-list"></div>
</div>

<!-- SMS -->
<div id="sms-screen" class="screen">
    <div class="header">
        <div class="status">宛先</div>
        <div class="display-number" id="chat-title">未選択</div>
    </div>

    <div id="message-list"></div>

    <div class="msg-input-area">
        <input id="smsInput" class="msg-input" placeholder="iMessage">
        <button onclick="sendSMS()" style="border:none;background:none;color:#007aff;">送信</button>
    </div>
</div>

<!-- ナビ -->
<div class="nav-bar">
    <div class="nav-item" onclick="switchTab('contacts')">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4z"/></svg>
        連絡先
    </div>
    <div class="nav-item active" onclick="switchTab('dialer')">
        <svg viewBox="0 0 24 24"><path d="M4 8h4V4H4z"/></svg>
        キーパッド
    </div>
    <div class="nav-item" onclick="switchTab('sms')">
        <svg viewBox="0 0 24 24"><path d="M20 2H4v20l4-4h12z"/></svg>
        メッセージ
    </div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBaMe4Cz_3W75F5NCtioAguONgukg3-k0g",
    authDomain: "my-call-14d70.firebaseapp.com",
    projectId: "my-call-14d70"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let MY_NUMBER = "";
let currentChatNumber = "";
let unsubscribeSMS = null;

const numberDisplay = document.getElementById("numberDisplay");

window.onload = () => {
    let saved = localStorage.getItem("my_number");
    if (!saved) {
        saved = "080-" + Math.floor(1000+Math.random()*9000) + "-" + Math.floor(1000+Math.random()*9000);
        localStorage.setItem("my_number", saved);
    }
    MY_NUMBER = saved;
    document.getElementById("my-number-info").innerText = "自分の番号: " + MY_NUMBER;
    loadContacts();
};

function switchTab(tab) {
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
    document.getElementById(tab+"-screen").classList.add("active");
    event.currentTarget.classList.add("active");
}

function press(n){ numberDisplay.innerText += n; }
function backspace(){ numberDisplay.innerText = numberDisplay.innerText.slice(0,-1); }

/* 連絡先 */
function loadContacts() {
    const list = document.getElementById("contact-list");
    const contacts = JSON.parse(localStorage.getItem("contacts") || "[]");
    list.innerHTML = "";
    contacts.forEach(c=>{
        const d=document.createElement("div");
        d.className="contact-item";
        d.innerHTML=`<span>${c.name}</span><span>${c.num}</span>`;
        d.onclick=()=>openChat(c.num);
        list.appendChild(d);
    });
}

function addContact(){
    const name=prompt("名前");
    const num=prompt("番号");
    if(!name||!num)return;
    const c=JSON.parse(localStorage.getItem("contacts")||"[]");
    c.push({name,num});
    localStorage.setItem("contacts",JSON.stringify(c));
    loadContacts();
}

/* SMS */
function openChat(num){
    if(!num)return;
    currentChatNumber=num;
    document.getElementById("chat-title").innerText=num;
    switchTab("sms");
    listenSMS(num);
}

async function sendSMS(){
    const text=document.getElementById("smsInput").value.trim();
    if(!text||!currentChatNumber)return;
    await db.collection("messages").add({
        from:MY_NUMBER,
        to:currentChatNumber,
        text,
        timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById("smsInput").value="";
}

function listenSMS(target){
    if(unsubscribeSMS)unsubscribeSMS();
    unsubscribeSMS=db.collection("messages")
        .orderBy("timestamp","asc")
        .onSnapshot(snap=>{
            const list=document.getElementById("message-list");
            list.innerHTML="";
            snap.forEach(doc=>{
                const d=doc.data();
                if(
                    (d.from===MY_NUMBER&&d.to===target)||
                    (d.from===target&&d.to===MY_NUMBER)
                ){
                    const b=document.createElement("div");
                    b.className="msg-bubble "+(d.from===MY_NUMBER?"msg-sent":"msg-received");
                    b.innerText=d.text;
                    list.appendChild(b);
                }
            });
            list.scrollTop=list.scrollHeight;
        });
}
</script>
</body>
</html>
