<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シンプルビデオ通話</title>
    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; }
        video { width: 300px; border-radius: 10px; background: #000; margin: 10px; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; }
        #room-name { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

    <h2>Webビデオ通話ルーム</h2>
    
    <div>
        <input type="text" id="room-name" placeholder="ルーム名（例：my-room）">
        <button id="join-button">入室する</button>
    </div>

    <div class="container" id="video-container">
        <video id="local-video" autoplay playsinline muted></video>
    </div>

    <script>
        const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = SkyWay;

        const joinButton = document.getElementById('join-button');
        const roomNameInput = document.getElementById('room-name');
        const videoContainer = document.getElementById('video-container');
        const localVideo = document.getElementById('local-video');

        joinButton.onclick = async () => {
            if (!roomNameInput.value) return alert('ルーム名を入力してください');

            // 1. SkyWayの初期化 (ここにAPIキーを入れる)
            const context = await SkyWayContext.Create('YOUR_SKYWAY_API_KEY');

            // 2. 自分の映像と音声を取得
            const { audio, video } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraStream();
            video.attach(localVideo);

            // 3. ルーム（P2P）に接続
            const room = await SkyWayRoom.FindOrCreate(context, {
                type: 'p2p',
                name: roomNameInput.value,
            });
            const me = await room.join();

            // 4. 自分の映像を相手に送る
            await me.publish(audio);
            await me.publish(video);

            // 5. 相手の映像を受信する処理
            const subscribe = async (publication) => {
                if (publication.publisher.id === me.id) return;
                const { stream } = await me.subscribe(publication.id);
                
                if (stream.contentType === 'video') {
                    const remoteVideo = document.createElement('video');
                    remoteVideo.autoplay = true;
                    remoteVideo.playsinline = true;
                    stream.attach(remoteVideo);
                    videoContainer.appendChild(remoteVideo);
                }
            };

            room.publications.forEach(subscribe);
            room.onStreamPublished.add((e) => subscribe(e.publication));
        };
    </script>
</body>
</html>
