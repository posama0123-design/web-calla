<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Voice Chat (6-Digit ID)</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
        .container { background: white; max-width: 400px; margin: auto; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input { width: 150px; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 20px; text-align: center; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; border: none; background: #007bff; color: white; font-weight: bold; }
        button:disabled { background: #ccc; }
        .status { margin: 15px 0; color: #d9534f; font-weight: bold; }
        #roomIdDisplay { font-size: 24px; color: #28a745; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>音声通話（数字ID版）</h2>
    <div class="status" id="status">1. まずマイクを起動してください</div>
    <button id="startAudio">マイク起動</button>
    <hr>
    <button id="createBtn" disabled>部屋を作成</button>
    <p>部屋番号: <span id="roomIdDisplay">------</span></p>
    <hr>
    <input type="number" id="joinInput" placeholder="000000">
    <button id="joinBtn" disabled>番号で参加</button>
    <audio id="remoteAudio" autoplay></audio>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBaMe4Cz_3W75F5NCtioAguONgukg3-k0g",
        authDomain: "my-call-14d70.firebaseapp.com",
        projectId: "my-call-14d70",
        storageBucket: "my-call-14d70.firebasestorage.app",
        messagingSenderId: "769393584037",
        appId: "1:769393584037:web:279aa04477f2649230ea4c",
        measurementId: "G-EXHXKKRT56"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let localStream, pc;

    const createPC = () => {
        pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        pc.ontrack = e => { document.getElementById('remoteAudio').srcObject = e.streams[0]; };
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    };

    document.getElementById('startAudio').onclick = async () => {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        document.getElementById('startAudio').disabled = true;
        document.getElementById('createBtn').disabled = false;
        document.getElementById('joinBtn').disabled = false;
        document.getElementById('status').innerText = "準備完了";
    };

    document.getElementById('createBtn').onclick = async () => {
        const roomId = Math.floor(100000 + Math.random() * 900000).toString();
        document.getElementById('roomIdDisplay').innerText = roomId;
        const roomRef = db.collection('rooms').doc(roomId);
        
        createPC();
        pc.onicecandidate = e => e.candidate && roomRef.collection('callerCandidates').add(e.candidate.toJSON());

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await roomRef.set({ offer: { type: offer.type, sdp: offer.sdp } });

        roomRef.onSnapshot(async snap => {
            const data = snap.data();
            if (!pc.currentRemoteDescription && data?.answer) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                document.getElementById('status').innerText = "通話中";
            }
        });

        roomRef.collection('calleeCandidates').onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
            });
        });
    };

    document.getElementById('joinBtn').onclick = async () => {
        const roomId = document.getElementById('joinInput').value;
        const roomRef = db.collection('rooms').doc(roomId);
        const roomSnapshot = await roomRef.get();
        if (!roomSnapshot.exists) return alert("部屋がありません");

        createPC();
        pc.onicecandidate = e => e.candidate && roomRef.collection('calleeCandidates').add(e.candidate.toJSON());

        const data = roomSnapshot.data();
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await roomRef.update({ answer: { type: answer.type, sdp: answer.sdp } });

        roomRef.collection('callerCandidates').onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
            });
        });
        document.getElementById('status').innerText = "通話中";
    };
</script>
</body>
</html>
