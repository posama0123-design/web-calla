<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç¨„É©„Ç±„ÉºÈÄöË©±„ÉªÊîπ</title>
    <style>
        body { background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: "MS Gothic", "Courier New", monospace; }
        .phone { width: 280px; background: #c0c0c0; border: 4px solid #888; border-radius: 20px; padding: 20px; box-shadow: 10px 10px 0 #000; }
        .screen { background: #9dbb16; border: 5px solid #222; height: 180px; padding: 10px; color: #000; overflow: hidden; position: relative; font-weight: bold; }
        
        /* „Éê„ÉÉ„ÉÜ„É™„ÉºÊ£í1Êú¨ */
        .battery { position: absolute; top: 5px; right: 5px; border: 2px solid #000; width: 25px; height: 10px; display: flex; align-items: center; padding: 1px; }
        .battery::after { content: ""; background: #000; width: 6px; height: 100%; } /* Ê£í1Êú¨ */
        
        .status-text { font-size: 14px; margin-top: 10px; border-bottom: 2px solid #000; padding-bottom: 5px; }
        .id-display { font-size: 24px; text-align: center; margin-top: 15px; }
        .input-area { margin-top: 15px; }
        input { width: 90%; background: transparent; border: none; border-bottom: 2px solid #000; font-size: 22px; text-align: center; outline: none; font-family: inherit; color: #000; }
        
        .buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .key { background: #eee; border: 2px solid #444; border-radius: 5px; padding: 12px; text-align: center; box-shadow: 2px 2px 0 #444; cursor: pointer; color: #000; font-size: 18px; user-select: none; }
        .key:active { transform: translate(2px, 2px); box-shadow: none; background: #ddd; }
        .call-btn { background: #008000; color: white; grid-column: span 3; font-weight: bold; margin-top: 5px; font-size: 20px; }
        .end-btn { background: #ff0000; color: white; display: none; grid-column: span 3; font-size: 20px; }
        #timer { font-size: 24px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="phone">
    <div class="screen">
        <div class="battery"></div>
        <div class="status-text" id="status">üì∂ ÂúèÂ§ñ</div>
        <div style="font-size: 10px; margin-top: 5px;">MY ID:</div>
        <div id="my-id" class="id-display">--</div>
        
        <div id="calling-ui" style="display:none; text-align:center; margin-top:10px;">
            <div style="font-size: 18px;">ÈÄöË©±‰∏≠</div>
            <div id="timer">00:00</div>
        </div>

        <div class="input-area" id="input-ui">
            <input type="text" id="room-name" placeholder="ÂêàË®ÄËëâ" readonly>
        </div>
    </div>

    <div class="buttons">
        <div class="key" onclick="pressKey('1')">1</div><div class="key" onclick="pressKey('2')">2</div><div class="key" onclick="pressKey('3')">3</div>
        <div class="key" onclick="pressKey('4')">4</div><div class="key" onclick="pressKey('5')">5</div><div class="key" onclick="pressKey('6')">6</div>
        <div class="key" onclick="pressKey('7')">7</div><div class="key" onclick="pressKey('8')">8</div><div class="key" onclick="pressKey('9')">9</div>
        <div class="key" onclick="pressKey('*')">*</div><div class="key" onclick="pressKey('0')">0</div><div class="key" onclick="pressKey('#')">#</div>
        
        <button id="make-call" class="key call-btn">üìû Áô∫‰ø°</button>
        <button id="end-call" class="key end-btn" onclick="location.reload()">üì¥ ÂàáÊñ≠</button>
    </div>
</div>

<audio id="remote-audio" autoplay></audio>

<script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
<script>
    const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = SkyWayRoom;
    const API_KEY = '1bb9fbdb-aa26-4350-a40e-7cc6429e1838';
    let localStream;

    // „Ç≠„Éº„Éë„ÉÉ„ÉâÊ©üËÉΩ
    function pressKey(num) {
        const input = document.getElementById('room-name');
        if (input.value.length < 5) {
            input.value += num;
        }
    }

    async function start() {
        const myId = Math.floor(Math.random() * 100);
        document.getElementById('my-id').innerText = myId;

        try {
            // Ëµ∑ÂãïÊôÇ„Å´„Éû„Ç§„ÇØ„ÇíË¶ÅÊ±Ç
            localStream = await SkyWayStreamFactory.createMicrophoneAudioStream();
            document.getElementById('status').innerText = "üì∂ ÂúèÂ§ñ („Éû„Ç§„ÇØOK)";

            document.getElementById('make-call').onclick = async () => {
                const roomName = document.getElementById('room-name').value;
                if(!roomName) return alert("‰∏ã„ÅÆ„Éú„Çø„É≥„ÅßÂêàË®ÄËëâ„ÇíÂÖ•„Çå„Å¶„Å≠ÔºÅ");

                document.getElementById('status').innerText = "‚òé Áô∫‰ø°‰∏≠...";
                
                try {
                    const context = await SkyWayContext.Create(API_KEY, { auth: { type: 'none' } });
                    const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: roomName });
                    const me = await room.join();
                    await me.publish(localStream);

                    room.onStreamPublished.add(async ({ stream }) => {
                        if (stream.contentType === 'audio') {
                            const { track } = await me.subscribe(stream.id);
                            track.attach(document.getElementById('remote-audio'));
                            
                            // ÁîªÈù¢Âàá„ÇäÊõø„Åà
                            document.getElementById('status').innerText = "üì∂ ÈÄöË©±‰∏≠";
                            document.getElementById('input-ui').style.display = 'none';
                            document.getElementById('my-id').style.display = 'none';
                            document.getElementById('calling-ui').style.display = 'block';
                            document.getElementById('make-call').style.display = 'none';
                            document.getElementById('end-call').style.display = 'block';
                            startTimer();
                        }
                    });
                } catch (err) {
                    alert("ÈÄö‰ø°„Ç®„É©„Éº„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Å≠");
                }
            };
        } catch (e) {
            document.getElementById('status').innerText = "‚ö†Ô∏è „Éû„Ç§„ÇØË®±ÂèØ„Å™„Åó";
            console.error(e);
        }
    }

    function startTimer() {
        let sec = 0;
        setInterval(() => {
            sec++;
            let m = Math.floor(sec / 60).toString().padStart(2, '0');
            let s = (sec % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    start();
</script>
</body>
</html>
