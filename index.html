<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¬ãƒ©ã‚±ãƒ¼é€šè©±</title>
    <style>
        /* ã‚¬ãƒ©ã‚±ãƒ¼é¢¨ãƒ¬ãƒˆãƒ­ãƒ‡ã‚¶ã‚¤ãƒ³ */
        body { background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: "MS Gothic", "Courier New", monospace; }
        .phone { width: 280px; background: #c0c0c0; border: 4px solid #888; border-radius: 20px; padding: 20px; box-shadow: 10px 10px 0 #000; }
        .screen { background: #9dbb16; border: 5px solid #222; height: 180px; padding: 10px; color: #000; overflow: hidden; position: relative; font-weight: bold; }
        .battery { position: absolute; top: 5px; right: 5px; border: 2px solid #000; width: 25px; height: 10px; }
        .status-text { font-size: 14px; margin-top: 10px; border-bottom: 2px solid #000; padding-bottom: 5px; }
        
        .id-display { font-size: 24px; text-align: center; margin-top: 20px; }
        .input-area { margin-top: 15px; }
        input { width: 90%; background: transparent; border: none; border-bottom: 2px solid #000; font-size: 18px; text-align: center; outline: none; font-family: inherit; }
        
        .buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .key { background: #eee; border: 2px solid #444; border-radius: 5px; padding: 10px; text-align: center; box-shadow: 2px 2px 0 #444; cursor: pointer; color: #000; }
        .key:active { transform: translate(2px, 2px); box-shadow: none; }
        .call-btn { background: #008000; color: white; grid-column: span 3; font-weight: bold; margin-top: 5px; }
        .end-btn { background: #ff0000; color: white; display: none; grid-column: span 3; }
    </style>
</head>
<body>

<div class="phone">
    <div class="screen">
        <div class="battery"></div>
        <div class="status-text" id="status">ðŸ“¶3G</div>
        <div style="font-size: 10px;">MY ID:</div>
        <div id="my-id" class="id-display">--</div>
        <div id="calling-ui" style="display:none; text-align:center; margin-top:20px;">
            <div style="font-size: 20px;">é€šè©±ä¸­</div>
            <div id="timer">00:00</div>
        </div>
        <div class="input-area" id="input-ui">
            <input type="text" id="room-name" placeholder="åˆè¨€è‘‰å…¥åŠ›" maxlength="5">
        </div>
    </div>

    <div class="buttons">
        <div class="key">1</div><div class="key">2</div><div class="key">3</div>
        <div class="key">4</div><div class="key">5</div><div class="key">6</div>
        <div class="key">7</div><div class="key">8</div><div class="key">9</div>
        <div class="key">*</div><div class="key">0</div><div class="key">#</div>
        <button id="make-call" class="key call-btn">ðŸ“ž ç™ºä¿¡</button>
        <button id="end-call" class="key end-btn" onclick="location.reload()">ðŸ“´ åˆ‡æ–­</button>
    </div>
</div>

<audio id="remote-audio" autoplay></audio>

<script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
<script>
    const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = SkyWayRoom;
    const API_KEY = '1bb9fbdb-aa26-4350-a40e-7cc6429e1838';

    async function start() {
        const myId = Math.floor(Math.random() * 100);
        document.getElementById('my-id').innerText = myId;

        try {
            const audioStream = await SkyWayStreamFactory.createMicrophoneAudioStream();
            document.getElementById('status').innerText = "æŽ¥ç¶šå¾…ã¡ (ã‚¢ãƒ³ãƒ†ãƒŠ3æœ¬)";

            document.getElementById('make-call').onclick = async () => {
                const roomName = document.getElementById('room-name').value;
                if(!roomName) return alert("åˆè¨€è‘‰ã‚’ã„ã‚Œã¦ã­ï¼");

                document.getElementById('status').innerText = "ç™ºä¿¡ä¸­...";
                const context = await SkyWayContext.Create(API_KEY, { auth: { type: 'none' } });
                const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: roomName });
                const me = await room.join();
                await me.publish(audioStream);

                room.onStreamPublished.add(async ({ stream }) => {
                    if (stream.contentType === 'audio') {
                        const { track } = await me.subscribe(stream.id);
                        track.attach(document.getElementById('remote-audio'));
                        
                        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                        document.getElementById('status').innerText = "é€šè©±ä¸­";
                        document.getElementById('input-ui').style.display = 'none';
                        document.getElementById('my-id').style.display = 'none';
                        document.getElementById('calling-ui').style.display = 'block';
                        document.getElementById('make-call').style.display = 'none';
                        document.getElementById('end-call').style.display = 'block';
                        startTimer();
                    }
                });
            };
        } catch (e) {
            document.getElementById('status').innerText = "ãƒžã‚¤ã‚¯è¨­å®šã‚¨ãƒ©ãƒ¼";
        }
    }

    function startTimer() {
        let sec = 0;
        setInterval(() => {
            sec++;
            let m = Math.floor(sec / 60).toString().padStart(2, '0');
            let s = (sec % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    start();
</script>
</body>
</html>
