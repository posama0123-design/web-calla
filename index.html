<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Voice Room</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; padding: 20px; background: #f0f2f5; color: #333; }
        .container { background: white; max-width: 400px; margin: 40px auto; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #007bff; margin-bottom: 20px; }
        input { width: 80%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { padding: 12px 20px; margin: 8px; cursor: pointer; border-radius: 8px; border: none; background: #007bff; color: white; font-weight: bold; transition: 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        .status { margin: 15px 0; padding: 10px; border-radius: 5px; background: #e9ecef; font-size: 14px; }
        #roomIdDisplay { font-family: monospace; background: #fff3cd; padding: 2px 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>音声ルーム</h2>
    
    <div class="status" id="status">1. マイクを許可してください</div>
    
    <button id="startAudio">マイクを起動する</button>
    
    <hr>
    
    <div>
        <button id="createBtn" disabled>部屋を作成（発信）</button>
        <p style="font-size: 0.9em;">部屋ID: <span id="roomIdDisplay">----</span></p>
    </div>
    
    <hr>
    
    <div>
        <input type="text" id="joinInput" placeholder="部屋IDを入力">
        <br>
        <button id="joinBtn" disabled>部屋に参加（着信）</button>
    </div>

    <audio id="remoteAudio" autoplay></audio>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<script>
    // --- あなたのFirebase設定を反映 ---
    const firebaseConfig = {
        apiKey: "AIzaSyBaMe4Cz_3W75F5NCtioAguONgukg3-k0g",
        authDomain: "my-call-14d70.firebaseapp.com",
        projectId: "my-call-14d70",
        storageBucket: "my-call-14d70.firebasestorage.app",
        messagingSenderId: "769393584037",
        appId: "1:769393584037:web:279aa04477f2649230ea4c",
        measurementId: "G-EXHXKKRT56"
    };

    // Firebase初期化
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let localStream = null;
    let pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    const statusText = document.getElementById('status');
    const remoteAudio = document.getElementById('remoteAudio');

    // 1. マイク準備
    document.getElementById('startAudio').onclick = async () => {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            
            statusText.innerText = "準備完了！「作成」か「参加」を選んでください";
            document.getElementById('startAudio').disabled = true;
            document.getElementById('createBtn').disabled = false;
            document.getElementById('joinBtn').disabled = false;
        } catch (e) {
            statusText.innerText = "エラー: マイクが許可されていないか、HTTPS環境ではありません。";
            console.error(e);
        }
    };

    // 2. 部屋を作成 (発信側)
    document.getElementById('createBtn').onclick = async () => {
        const roomRef = db.collection('rooms').doc();
        const roomId = roomRef.id;
        document.getElementById('roomIdDisplay').innerText = roomId;
        statusText.innerText = "部屋を作成しました。相手にIDを教えてください。";

        // ICE Candidateの収集（接続経路の確保）
        pc.onicecandidate = e => {
            if (e.candidate) {
                roomRef.collection('callerCandidates').add(e.candidate.toJSON());
            }
        };

        // オファー（通話の提案）の作成
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await roomRef.set({ offer: { type: offer.type, sdp: offer.sdp } });

        // 相手からのアンサーを待機
        roomRef.onSnapshot(snapshot => {
            const data = snapshot.data();
            if (!pc.currentRemoteDescription && data?.answer) {
                pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                statusText.innerText = "相手が参加しました！通話中...";
            }
        });

        // 相手のICE Candidateを監視
        roomRef.collection('calleeCandidates').onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') {
                    pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                }
            });
        });
    };

    // 3. 部屋に参加 (参加側)
    document.getElementById('joinBtn').onclick = async () => {
        const roomId = document.getElementById('joinInput').value.trim();
        if (!roomId) return alert("部屋IDを入力してください");

        const roomRef = db.collection('rooms').doc(roomId);
        const roomSnapshot = await roomRef.get();

        if (!roomSnapshot.exists) {
            alert("部屋が見つかりません。IDを確認してください。");
            return;
        }

        statusText.innerText = "接続しています...";

        pc.onicecandidate = e => {
            if (e.candidate) {
                roomRef.collection('calleeCandidates').add(e.candidate.toJSON());
            }
        };

        const data = roomSnapshot.data();
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await roomRef.update({ answer: { type: answer.type, sdp: answer.sdp } });

        // 作成者側のICE Candidateを監視
        roomRef.collection('callerCandidates').onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') {
                    pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                }
            });
        });

        statusText.innerText = "接続成功！通話中...";
    };

    // 相手の音声が届いた時の処理
    pc.ontrack = e => {
        remoteAudio.srcObject = e.streams[0];
    };
</script>

</body>
</html>
