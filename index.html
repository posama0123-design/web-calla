<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Voice Chat</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; padding: 50px; background: #f4f7f6; }
        .status-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-block; }
        .visualizer { width: 200px; height: 10px; background: #ddd; margin: 20px auto; border-radius: 5px; overflow: hidden; }
        .bar { height: 100%; width: 0%; background: #28a745; transition: width 0.1s; }
        .controls { margin-top: 20px; }
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; margin: 5px; transition: 0.3s; }
        #startButton { background: #6c757d; color: white; }
        #callButton { background: #28a745; color: white; }
        #hangupButton { background: #dc3545; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="status-card">
        <h2>音声通話モード</h2>
        <p id="status">マイクを許可してください</p>
        
        <div class="visualizer"><div id="volumeBar" class="bar"></div></div>

        <audio id="remoteAudio" autoplay></audio>

        <div class="controls">
            <button id="startButton">マイク起動</button>
            <button id="callButton" disabled>通話開始</button>
            <button id="hangupButton" disabled>終了</button>
        </div>
    </div>

    <script>
        let localStream;
        let peerConnection;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        const remoteAudio = document.getElementById('remoteAudio');
        const startButton = document.getElementById('startButton');
        const callButton = document.getElementById('callButton');
        const hangupButton = document.getElementById('hangupButton');
        const statusText = document.getElementById('status');

        // 1. マイクのみ取得
        startButton.onclick = async () => {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                statusText.innerText = "マイク準備完了";
                startButton.disabled = true;
                callButton.disabled = false;
                
                // 音声レベルの簡易可視化（動作確認用）
                setupVisualizer(localStream);
            } catch (err) {
                statusText.innerText = "マイクの取得に失敗しました";
                console.error(err);
            }
        };

        // 2. 通話接続処理
        callButton.onclick = async () => {
            statusText.innerText = "接続中...";
            callButton.disabled = true;
            hangupButton.disabled = false;

            peerConnection = new RTCPeerConnection(config);
            
            // 音声トラックを追加
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // 相手の音声を受信
            peerConnection.ontrack = (event) => {
                remoteAudio.srcObject = event.streams[0];
                statusText.innerText = "通話中";
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            console.log('SDP Offer作成完了。シグナリングサーバーへ送ってください。');
        };

        hangupButton.onclick = () => {
            location.reload();
        };

        // おまけ：マイクが反応しているか視覚的に出す関数
        function setupVisualizer(stream) {
            const audioContext = new AudioContext();
            const source = audioContext.createMediaStreamSource(stream);
            const processor = audioContext.createScriptProcessor(2048, 1, 1);
            source.connect(processor);
            processor.connect(audioContext.destination);
            processor.onaudioprocess = (e) => {
                const input = e.inputBuffer.getChannelData(0);
                const max = Math.max(...input);
                document.getElementById('volumeBar').style.width = (max * 100) + "%";
            };
        }
    </script>
</body>
</html>
