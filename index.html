<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çˆ†é€ŸéŸ³å£°é€šè©±ã‚µã‚¤ãƒˆ</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #0f172a; color: #e2e8f0; padding: 20px; }
        .card { background: #1e293b; padding: 30px; border-radius: 12px; display: inline-block; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); max-width: 400px; width: 90%; }
        h1 { font-size: 1.5rem; margin-bottom: 20px; }
        input { width: 80%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #334155; color: white; text-align: center; }
        button { width: 85%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; background: #3b82f6; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #2563eb; }
        #status { margin-top: 20px; font-size: 0.9rem; color: #94a3b8; }
        .id-display { font-size: 1.2rem; color: #60a5fa; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>

    <div class="card">
        <h1>ğŸ™ éŸ³å£°é€šè©±ãƒ«ãƒ¼ãƒ </h1>
        <p>ã‚ãªãŸã®ç•ªå·</p>
        <div id="my-id" class="id-display">ç™ºè¡Œä¸­...</div>
        
        <hr style="border: 0.5px solid #334155; margin: 20px 0;">
        
        <input type="text" id="their-id" placeholder="åˆè¨€è‘‰ï¼ˆæ•°å­—ãªã©ï¼‰ã‚’å…¥åŠ›">
        <button id="make-call">é€šè©±ã‚’é–‹å§‹ã™ã‚‹</button>
        
        <div id="status">ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦å¾…æ©Ÿã—ã¦ãã ã•ã„</div>
        <audio id="remote-audio" autoplay></audio>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
    <script>
        const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = SkyWayRoom;

        // ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³IDã‚’è¨­å®šæ¸ˆã¿ã§ã™
        const API_KEY = '1bb9fbdb-aa26-4350-a40e-7cc6429e1838'; 

        async function start() {
            // ãƒ©ãƒ³ãƒ€ãƒ ãªè‡ªåˆ†ã®ç•ªå·ã‚’è¡¨ç¤ºï¼ˆå‹é”ã«æ•™ãˆã‚‹ç”¨ï¼‰
            const myId = "ID-" + Math.floor(Math.random() * 10000);
            document.getElementById('my-id').innerText = myId;

            try {
                // ãƒã‚¤ã‚¯ã®æº–å‚™
                const audioStream = await SkyWayStreamFactory.createMicrophoneAudioStream();
                document.getElementById('status').innerText = "ãƒã‚¤ã‚¯æº–å‚™å®Œäº†ï¼åˆè¨€è‘‰ã‚’å…¥ã‚Œã¦é–‹å§‹ã—ã¦ãã ã•ã„";

                document.getElementById('make-call').onclick = async () => {
                    const roomName = document.getElementById('their-id').value;
                    if(!roomName) return alert("åˆè¨€è‘‰ï¼ˆéƒ¨å±‹åï¼‰ã‚’æ±ºã‚ã¦å…¥åŠ›ã—ã¦ã­");

                    document.getElementById('status').innerText = "æ¥ç¶šä¸­...";

                    const context = await SkyWayContext.Create(API_KEY);
                    const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: roomName });
                    const me = await room.join();
                    
                    // è‡ªåˆ†ã®å£°ã‚’é€ä¿¡
                    await me.publish(audioStream);

                    // ç›¸æ‰‹ã®å£°ã‚’å—ä¿¡ã—ã¦å†ç”Ÿ
                    room.onStreamPublished.add(async ({ stream }) => {
                        if (stream.contentType === 'audio') {
                            const { track } = await me.subscribe(stream.id);
                            track.attach(document.getElementById('remote-audio'));
                            document.getElementById('status').innerText = "é€šè©±ä¸­ï¼ãŠè©±ã—ã§ãã¾ã™";
                        }
                    });
                };
            } catch (e) {
                document.getElementById('status').innerText = "ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„";
            }
        }
        start();
    </script>
</body>
</html>
