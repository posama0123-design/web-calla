<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¬ãƒ©ã‚±ãƒ¼ãƒ»ç©¶æ¥µå®Œå…¨ä½“</title>
    <style>
        body { background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: "MS Gothic", "Courier New", monospace; color: #000; overflow: hidden; }
        .phone { width: 320px; background: #c0c0c0; border: 4px solid #888; border-radius: 20px; padding: 20px; box-shadow: 10px 10px 0 #000; }
        .screen { background: #9dbb16; border: 5px solid #222; height: 260px; padding: 10px; position: relative; font-weight: bold; display: flex; flex-direction: column; box-sizing: border-box; }
        
        /* ç”»é¢ä¸Šéƒ¨ */
        .status-bar { font-size: 12px; border-bottom: 2px solid #000; padding-bottom: 3px; display: flex; justify-content: space-between; }
        .battery { border: 2px solid #000; width: 22px; height: 9px; display: flex; align-items: center; padding: 1px; }
        .battery::after { content: ""; background: #000; width: 6px; height: 100%; }

        /* ã‚¢ãƒ—ãƒªç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
        .app-layer { flex-grow: 1; display: none; text-align: center; justify-content: center; flex-direction: column; }
        .active { display: flex; }

        /* SMSã‚¢ãƒ—ãƒªã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .sms-app { font-size: 12px; text-align: left; }
        .sms-log { border: 1px solid #000; height: 100px; margin: 5px 0; overflow-y: auto; background: rgba(0,0,0,0.05); padding: 2px; }

        /* å…¥åŠ›æ¬„ */
        input { width: 100%; background: transparent; border: none; font-size: 20px; text-align: center; outline: none; color: #000; border-bottom: 1px solid #000; }

        /* ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ï¼ˆæ“ä½œã‚­ãƒ¼å®Ÿè£…ï¼‰ */
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 10px; }
        .key { background: #eee; border: 2px solid #444; border-radius: 5px; padding: 12px 5px; text-align: center; box-shadow: 2px 2px 0 #444; font-size: 14px; cursor: pointer; user-select: none; }
        .key:active { transform: translate(1px, 1px); box-shadow: none; }
        
        /* æ“ä½œç”¨ã‚­ãƒ¼ */
        .op-key { background: #ddd; font-weight: bold; }
        .call-key { background: #2ecc71; color: white; }
        .end-key { background: #e74c3c; color: white; }
    </style>
</head>
<body>

<div class="phone">
    <div class="screen">
        <div class="status-bar">
            <div id="signal">ğŸ“¶åœå¤–</div>
            <div id="app-title">é›»è©±</div>
            <div class="battery"></div>
        </div>

        <div id="app-phone" class="app-layer active">
            <div style="font-size: 10px;">ID: <span id="my-id">--</span></div>
            <input type="text" id="phone-num" placeholder="ç•ªå·å…¥åŠ›" readonly>
            <div id="calling-status" style="display:none; margin-top:10px;">
                é€šè©±ä¸­<br><span id="timer" style="font-size:24px;">00:00</span>
            </div>
        </div>

        <div id="app-sms" class="app-layer">
            <div class="sms-app">
                ã€âœ‰ ï¾’ï½°ï¾™ä½œæˆã€‘
                <input type="text" id="sms-text" placeholder="æœ¬æ–‡å…¥åŠ›" readonly>
                <div class="sms-log" id="sms-log">å—ä¿¡ï¾’ï½°ï¾™ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </div>
    </div>

    <div class="keypad">
        <div class="key op-key" onclick="switchApp('phone')">é›»è©±</div>
        <div class="key op-key" onclick="switchApp('sms')">ï¾’ï½°ï¾™</div>
        <div class="key op-key" onclick="deleteChar()">æ¶ˆå»</div>

        <div class="key" onclick="pressNum('1')">1</div><div class="key" onclick="pressNum('2')">2</div><div class="key" onclick="pressNum('3')">3</div>
        <div class="key" onclick="pressNum('4')">4</div><div class="key" onclick="pressNum('5')">5</div><div class="key" onclick="pressNum('6')">6</div>
        <div class="key" onclick="pressNum('7')">7</div><div class="key" onclick="pressNum('8')">8</div><div class="key" onclick="pressNum('9')">9</div>
        <div class="key" onclick="pressNum('*')">ï¼Š</div><div class="key" onclick="pressNum('0')">0</div><div class="key" onclick="sendAction()">ï¼ƒ</div>

        <div class="key call-key" onclick="startCall()">ğŸ“ç™ºä¿¡</div>
        <div class="key op-key">æ±ºå®š</div>
        <div class="key end-key" onclick="location.reload()">ğŸ“´åˆ‡æ–­</div>
    </div>
</div>

<audio id="remote-audio" autoplay></audio>

<script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room.js"></script>
<script>
    const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = SkyWayRoom;
    const API_KEY = '1bb9fbdb-aa26-4350-a40e-7cc6429e1838';
    let localStream, currentApp = 'phone';

    // 1. ãƒã‚¤ã‚¯è¨±å¯ã‚’æœ€åˆã«ç¢ºå®Ÿã«æ±‚ã‚ã‚‹
    async function init() {
        document.getElementById('my-id').innerText = Math.floor(Math.random() * 999);
        try {
            localStream = await SkyWayStreamFactory.createMicrophoneAudioStream();
            document.getElementById('signal').innerText = "ğŸ“¶è‰¯å¥½";
            alert("ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¾ã—ãŸã€‚é€šè©±ãŒå¯èƒ½ã§ã™ã€‚");
        } catch (e) {
            alert("ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ï¼è¨±å¯ã—ãªã„ã¨é€šè©±ã§ãã¾ã›ã‚“ã€‚");
            document.getElementById('signal').innerText = "âš ï¸åœæ­¢";
        }
    }

    // ã‚¢ãƒ—ãƒªåˆ‡ã‚Šæ›¿ãˆ
    function switchApp(app) {
        currentApp = app;
        document.querySelectorAll('.app-layer').forEach(el => el.classList.remove('active'));
        document.getElementById('app-' + app).classList.add('active');
        document.getElementById('app-title').innerText = app === 'phone' ? 'é›»è©±' : 'ï¾’ï½°ï¾™';
    }

    // ã‚­ãƒ¼å…¥åŠ›
    function pressNum(n) {
        const id = currentApp === 'phone' ? 'phone-num' : 'sms-text';
        document.getElementById(id).value += n;
    }

    function deleteChar() {
        const id = currentApp === 'phone' ? 'phone-num' : 'sms-text';
        const el = document.getElementById(id);
        el.value = el.value.slice(0, -1);
    }

    // 2. é€šè©±æ©Ÿèƒ½ã®å®Ÿè£…
    async function startCall() {
        const num = document.getElementById('phone-num').value;
        if (!num) return alert("ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (!localStream) return alert("ãƒã‚¤ã‚¯ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“");

        document.getElementById('signal').innerText = "â˜æ¥ç¶šä¸­";
        try {
            const context = await SkyWayContext.Create(API_KEY, { auth: { type: 'none' } });
            const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: num });
            const me = await room.join();
            await me.publish(localStream);

            room.onStreamPublished.add(async ({ stream }) => {
                if (stream.contentType === 'audio') {
                    const { track } = await me.subscribe(stream.id);
                    track.attach(document.getElementById('remote-audio'));
                    
                    document.getElementById('signal').innerText = "ğŸ“¶é€šè©±ä¸­";
                    document.getElementById('phone-num').style.display = 'none';
                    document.getElementById('calling-status').style.display = 'block';
                    startTimer();
                }
            });
        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼: é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            location.reload();
        }
    }

    function sendAction() {
        if (currentApp === 'sms') {
            const txt = document.getElementById('sms-text').value;
            if(txt) {
                document.getElementById('sms-log').innerText = "é€ä¿¡æ¸ˆ: " + txt;
                document.getElementById('sms-text').value = "";
            }
        }
    }

    function startTimer() {
        let sec = 0;
        setInterval(() => {
            sec++;
            let m = Math.floor(sec / 60).toString().padStart(2, '0');
            let s = (sec % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    init();
</script>
</body>
</html>
