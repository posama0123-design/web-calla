<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Voice Room</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
        .container { background: white; max-width: 400px; margin: auto; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input { width: 80%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; border: none; background: #007bff; color: white; }
        button:disabled { background: #ccc; }
        .status { margin: 15px 0; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h2>音声ルーム</h2>
    
    <div class="status" id="status">マイクを許可してください</div>
    
    <button id="startAudio">1. マイク準備</button>
    <hr>
    
    <div>
        <button id="createBtn" disabled>部屋を作成</button>
        <p>部屋ID: <span id="roomIdDisplay">-</span></p>
    </div>
    
    <hr>
    
    <div>
        <input type="text" id="joinInput" placeholder="部屋IDを入力">
        <button id="joinBtn" disabled>部屋に参加</button>
    </div>

    <audio id="remoteAudio" autoplay></audio>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<script>
    // --- ⚠️ ここにあなたのFirebase設定を貼り付けてください ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };
    // -----------------------------------------------------

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let localStream = null;
    let pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

    const status = document.getElementById('status');

    // 1. マイク準備
    document.getElementById('startAudio').onclick = async () => {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        status.innerText = "準備完了！部屋を作るか参加してください";
        document.getElementById('createBtn').disabled = false;
        document.getElementById('joinBtn').disabled = false;
    };

    // 2. 部屋を作成
    document.getElementById('createBtn').onclick = async () => {
        const roomRef = db.collection('rooms').doc(); // ランダムID生成
        document.getElementById('roomIdDisplay').innerText = roomRef.id;

        pc.onicecandidate = e => {
            if (e.candidate) roomRef.collection('callerCandidates').add(e.candidate.toJSON());
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await roomRef.set({ offer: { type: offer.type, sdp: offer.sdp } });

        roomRef.onSnapshot(snapshot => {
            const data = snapshot.data();
            if (!pc.currentRemoteDescription && data?.answer) {
                pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
        });

        status.innerText = "待機中... IDを相手に送ってください";
    };

    // 3. 部屋に参加
    document.getElementById('joinBtn').onclick = async () => {
        const roomId = document.getElementById('joinInput').value;
        const roomRef = db.collection('rooms').doc(roomId);
        const roomSnapshot = await roomRef.get();

        if (!roomSnapshot.exists) return alert("部屋が見つかりません");

        pc.onicecandidate = e => {
            if (e.candidate) roomRef.collection('calleeCandidates').add(e.candidate.toJSON());
        };

        const data = roomSnapshot.data();
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await roomRef.update({ answer: { type: answer.type, sdp: answer.sdp } });

        roomRef.collection('callerCandidates').onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
            });
        });

        status.innerText = "接続成功！";
    };

    pc.ontrack = e => {
        document.getElementById('remoteAudio').srcObject = e.streams[0];
    };
</script>
</body>
</html>
